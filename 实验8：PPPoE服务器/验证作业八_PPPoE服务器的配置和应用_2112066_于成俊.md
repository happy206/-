# 实验8：PPPoE服务器的配置和应用



#### 学号：2112066   

#### 姓名：于成俊      

#### 专业：密码科学与技术



## 一、实验内容：

PPPoE服务器配置和应用实验在虚拟仿真环境下完成，要求如下：

（1）仿真有线局域网接入互联网的场景，正确配置PPPoE服务器的认证协议、地址池、虚拟模板和物理接口，使内网用户经认证后才能正常访问外部互联网。

（2）仿真家庭网络中，无线和有线终端（主机、智能电话等）连入小型路由器，由小型路由器统一接入互联网服务运营商PPPoE服务器的场景。对小型路由器和PPPoE服务器进行设置，使家庭网络中的用户经认证后才能正常访问外部互联网。



## 二、实验原理：

### 1.PPPoE：

PPPoE是一种以太网上使用的“点到点”协议，它通过为每个以太网用户建立一条点对点的会话连接，从而简化网络接入服务提供商的接入控制。采用PPPoE技术时，网络服务提供商不但能通过同一个接入设备连接远程的多个用户主机，而且能提供类似点到点链路的接入控制和计费功能。

### 2.PPPoE协议：

整个PPPoE协议分成了发现和PPP会话两个阶段。其中：

- **发现阶段：**在以太网用户与PPPoE服务器之间建立一条点到点的会话连接。
- **PPP会话阶段：** 利用这些点到点的会话连接传送PPP数据。

### 3.PPPoE协议发现阶段：

发现阶段的主要任务是为了以太网用户分配会话ID，以便逻辑上建立一条到达PPPoE服务器的点到点会话连接。一个网络中通常可以安装多台PPPoE服务器，但用户发现多个PPPoE服务器可用时，可以选择并使用其中的一个。

- **主机广播PADI数据包：** 为了发现网络中存在的PPPoE服务器，用户主机广播一个PADI数据包。该数据包含有用户A希望得到的PPPoE服务器并希望PPPoE服务器进行应答。
- **PPPoE服务器回送PADO数据包**：因为用户主机是以广播形式发送的PADI数据包，所以如果有多个PPPoE服务器，它们都可以收到该信息。如果它们都能提供PADI数据包中要求的服务，那么它们分别使用PADO数据包对用户进行响应。
- **主机发送PADR数据包：** 在主机收到一个或多个PPPoE服务器响应的PADO数据包后，从中选择一个使用。然后，主机向选择的PPPoE服务器以单播方式发送PADR数据包，要求该服务器为其分配会话ID。
- **PPPoE服务器回送PADS数据包：**当接收到用户主机发送的PADR数据包后，PPPoE服务器为用户创建一个会话ID，然后使用PADS数据包将该会话ID传递给用户。一旦用户收到PADS数据包并解析出会话ID，用户和PPPoE服务器之间就能够建立一条点到点的会话连接。

用户与PPPoE服务器之间的“点到点”会话连接链路是通过主机的MAC地址和会话ID标识的，因此PPP会话阶段传输的数据包中必须包含该会话ID，以便主机和PPPoE服务器识别一个PPPoE数据属于哪个用户。

**图示如下**：

![106](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\106.png)

### 4.PPP会话阶段：

在用户获得PPPoE服务器为自己分配的会话ID后,PPPoE协议进入PPP会话阶段。PPP会话阶段包括PPP的LCP处理、NCP处理以及身份认证处理等过程。所有 PPP数据包都必须封装在以太网帧中传专递,而且帧的目的地址必须是单播地址。由于主机MAC地址与会话ID的结合才能使 PPPoE 确认一个以太网数据帧来自哪个用户,因此在整个PPP会话阶段中,用户主机与 PPPoE服务器之间传递的数据包中会话ID必须保持不变,而且该会话ID必须是发现阶段 PPPoE服务器为其分配的会话ID。

### 5.PPPoE应用：

- 局域网用户接入控制：

![107](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\107.png)

- ADSL用户接入控制：

![108](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\108.png)

## 三、实验过程

### （1）仿真有线局域网接入互联网的场景，正确配置PPPoE服务器的认证协议、地址池、虚拟模板和物理接口，使内网用户经认证后才能正常访问外部互联网。

#### 1.建立网络拓扑

![80](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\80.png)

#### 2.配置主机IP地址、路由器IP地址和服务器IP地址

##### 表格如下：

|    Machine    | IPv4 Address |  Subnet Mask  |    网关     |
| :-----------: | :----------: | :-----------: | :---------: |
|      PC0      | 由路由器分配 | 255.255.255.0 |             |
|      PC1      | 由路由器分配 | 255.255.255.0 |             |
|      PC2      | 192.168.3.2  | 255.255.255.0 | 192.168.3.1 |
|    Server0    | 192.168.2.3  | 255.255.255.0 |             |
|    Server1    | 192.168.3.3  | 255.255.255.0 | 192.168.3.1 |
| Router0 Fa0/0 | 192.168.1.1  | 255.255.255.0 |             |
| Router0 Fa0/1 | 192.168.2.1  | 255.255.255.0 |             |
| Router1 Fa0/0 | 192.168.2.2  | 255.255.255.0 |             |
| Router1 Fa0/1 | 192.168.3.1  | 255.255.255.0 |             |

由于配置IP地址并不是本次实验的重点，所以不在这里描述配置过程了。

#### 3.配置认证协议和用户

为了鉴别接入用户的合法性，需要在接入服务器启动和配置认证服务，在本次实验中，aaa命令是全局模式下用于认证、授权和计费的服务，启动认证和选择认证的命令如下(并绑定主机的ip地址和端口号)：

```
Router(config)#aaa new-model
Router(config)#aaa authentication ppp myPPPoE group radius
Router(config)#radius-server host 192.168.2.3 auth-port 1645 key radius123
```

这三条指令创建了一个名为`myPPPoE`的使用`radius`协议的认证方式，并且指定了地址为`192.168.2.3`的服务器为`radius-server`，指定了接口和密码。

执行命令如下：

![81](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\81.png)

#### 4.配置AAA服务器

1. 首先需要将对应提供服务的路由的名字（可以在路由器中查找到）、ip地址以及端口号等信息添加到服务器的AAA服务中去
2. 接下来要在服务器中设置相应的用户和其口令，便于用户的连接以及将其投递到外部网络中，实现对其的服务
3. 设置好之后会有如下所以的服务器AAA服务界面：

![82](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\82.png)

#### 5.配置地址池

用户接入时，PPPoE服务器需要对用户分配IP地址。因此，需要在配置PPPoE时建立一个地址池，用于给指定分配给登录用户的IP地址范围。建立本地地址池可以在全局配置模式下使用`ip local pool PoolName StartIP EndIP`命令。

1. PoolName是一个用户选择的字符串，用于标识该IP地址池
2. StartIP和EndIP分别表示该地址池的起始IP地址和终止IP地址

在本次实验中使用如下命令来为其分配地址池：

```
ip local pool myPool 192.168.1.100 192.168.1.200
```



#### 6.配置虚拟模板

网络中通常具有接口，通过其连接网络或其他设备。网络接口可以进行配置。

使用PPPoE服务时，PPPoE服务器会为每个请求接入的用户创建一个逻辑接口，让用户感觉他们连入了一个真实存在的接口，所用的命令如下：

- `Router(config)#interface virtual-template 1`：这条命令创建编号为1的虚拟模版，并进入该模版的配置模式。
- `Router(config-if)#ip unnumbered fa0/0`：这条命令的含义是不为利用该模版创建的逻辑接口分配IP地址（如果该接口需要产生并发送IP数据报，那么数据报的源IP地址可以使用fa0/0接口的ip地址）
- `Router(config-if)#peer default ip address pool myPool`：这条命令指出服务器为请求的用户分配IP地址时采用地址池的IP地址
- `Router(config-if)#ppp authentication chap myPPPoE`：这条命令表明该模版将使用chao协议进行认证，同时采用myPPPoE中规定的认证方式
- `Router(config-if)#exit`：退出config-if模式

运行命令如下：

![83](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\83.png)

#### 7.创建BBA组

在配置PPPoE服务器时，需要建立相关的PPPoE协议组，相应的命令如下：

```
Router(config)#bba-group pppoe myBBAGroup
Router(config-bba)#virtual-template 1
Router(config-bba)#exit
```

需要注意的cisco路由器只允许建立一个运行的PPPoE协议的BBA组，因此，如果已经建立了一个名字为myGroup的PPPoE组，那么路由器将不允许建立另一个运行的PPPoE协议的BBA组。

命令运行如下：

![84](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\84.png)

#### 8.配置物理接口

PPPoE协议最终需要运行在一个物理接口上，因此需要在发送、接收PPPoE报文的接口上启动PPPoE功能，具体命令如下：

- `Router(config)#interface fa0/0`：进入接口配置模式
- `Router(config-if)#pppoe enable group myBBAGroup`：代表允许在该接口上启动PPPoE协议
- `Router(config-if)#exit`：退出config-if模式

由于在Cisco路由器中只有一个采用PPPoE协议的BBA组，所以不需要指定组名。

命令运行如下：

![85](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\85.png)

#### 9.验证配置的PPPoE接入服务器

完成以上配置后，PPPoE接入服务器就可以接受客户端的请求，对请求用户进行身份认证，并为验证通过的用户创建逻辑接口

创建完成后，PPPoE接入服务器就能在创建的逻辑接口上收发和处理PPPoE用户的数据报文，首先输入在PPPoE接入服务器上建立的用户名和密码（比如alice和alice123）,连接成功后如下图所示：

![86](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\86.png)

然后就可以用主机PC0访问外部的主机PC2，ping命令如下图所示：

![87](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\87.png)

tracert命令如下：

![88](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\88.png)

最后用PC0访问server1的web服务：

![89](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\89.png)

### （2）仿真家庭网络中，无线和有线终端（主机、智能电话等）连入小型路由器，由小型路由器统一接入互联网服务运营商PPPoE服务器的场景。对小型路由器和PPPoE服务器进行设置，使家庭网络中的用户经认证后才能正常访问外部互联网。

#### 1.建立网络拓扑

在实验（1）的基础上，增加一个`WRT 300N Wireless Router0`和一个主机PC3，如下图：

![109](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\109.png)

#### 2.配置主机IP地址、路由器IP地址和服务器IP地址

除了PC3和Wireless Router0，其他的配置与实验（1）一样，这里不再赘述。PC3是动态获取IP，后面会配置的。

#### 3.配置WRT 300N Wireless Router0

- 点击Wireless Router0的GUI界面，讲Internet Connection type改为PPPoE类型，并输入PPPoE服务器注册的用户名和密码。

![111](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\111.png)

- 将Wireless Router0的IP地址设置为192.168.0.100，子网掩码设置为255.255.255.0；然后开启DHCP服务，设置DHCP 地址池，这些地址供无线客户端使用。客户端接收 IP 地址和掩码并将路由器的 IP 地址作为网关使用。配置如下图：



![112](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\112.png)

- 配置完后，不要忘记，划到最下面，点击Save Settings

![113](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\113.png)

#### 4.为 PC3 添加无线连接

- 单击 PC3，然后单击 Physical（物理）选项卡。 Physical Device View（物理设备视图）中是该 PC 的图像。单击 PC 上的电源按钮将其关闭。

  ![114](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\114.png)

  

- 然后删除快速以太网卡，即将其拖到窗口左下角，注意，网卡位于机器底部，所以要划到最下面才能看见。

![115](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\115.png)

- 在 Modules（模块）下，找到 WMP300N 并将其拖放到快速以太网卡先前所在的位置，最后重新打开电源。

![116](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\116.png)

- 配置成功后，发现PC3和Wireless Router0连接成功。

![117](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\117.png)

- 点击PC3，将Interface改为Wireless0，然后将IP Configuration改为DHCP，就可以看见它被动态分配的IP地址了。

![118](验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\118.png)

- 在PC3上，访问外网的服务器的Web服务，发现可以访问：

![119](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\119.png)

- 在PC3上，ping外网的主机（PC2）也可以ping通

![120](C:\Users\86180\Desktop\实验8：PPPoE服务器\验证作业八_PPPoE服务器的配置和应用_2112066_于成俊.assets\120.png)





## 四、总结

本次在做实验的仿真实验出现了以下问题：

将仿真软件关闭后，再次打开，发现无法连接服务器。调查发现，之前路由器为PC0分配的地址不见了。查阅资料知道，每次重新启动系统时，路由器**相关**的配置文件都会恢复为默认值，所以每次得重新绑定相应的接口，这样才能在服务器上连接成功。





代码链接：https://github.com/happy206/Network-Technology-and-Applications
